{% extends "../base.html" %}
{% load static %}
{% load i18n %}

<head>
    <script src="{% static 'js/mathjax.js' %}"></script>
</head>

{% block content %}
    <h1>{% trans 'Welcome' %} {{ user.username }} </h1>

    <h2>{% trans 'Choose an Option' %}</h2>
{#    <h1>{% trans 'great webte assigment - student' %}</h1>#}

    <ul>
        <li><a href="#">{% trans 'Take the Exam' %}</a></li>
        <li><a {% url 'previousAssignments' %}> {% trans 'View Previous Assignments' %}</a></li>
    </ul>

    <h2>{% trans 'Tasks Assigned to ' %}{{ request.user.username }}</h2>
    <table id="tasksTable">
        <thead>
        <tr>
            <th>Task ID</th>
            <th>Task</th>
            <th>Batch</th>
            <th>Solve</th>
        </tr>
        </thead>
        <tbody>
        {% for task in tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.task }}</td>
                <td>{{ task.batch.name }}</td>
                <td>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#task-modal" onclick='fillTaskModal("{{ task.id }}", "{{ task.task }}", "{{ task.image }}")'>
                        solve
                    </button>
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="4">{% trans 'No tasks assigned.' %}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% include 'zaverecne_zadanie/students/task_modal.html' %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#tasksTable').DataTable();
        });

        function fillTaskModal(id, task, image){
            if (image) {
                document.getElementById("task-image").src = `/${image}`;
                document.getElementById("task-image").style.display = "block";
            }
            else {
                document.getElementById("task-image").style.display = "none";
            }
            let str = insertNewlines(task, 100);
            console.log(str);
            str = str.replaceAll('$', "");
                        console.log(str);

            str = str.replace(/ /g, '\\hspace{1mm}');
            str = str.replace('dfrac', '\\dfrac');
            convertEquation(str);
            console.log(str);
        }


        function convertEquation(latexEquation) {
            var equationElement = document.getElementById('task');
            katex.render(latexEquation, equationElement, {
                throwOnError: true,
                displayMode: true
            });
        }

        function insertNewlines(equation, lineLength) {
            let result = '';
            let currentLineLength = 0;

            for (let i = 0; i < equation.length; i++) {
                const char = equation[i];
                result += char;
                currentLineLength++;

                // Check if the current line length exceeds the specified line length
                if (currentLineLength >= lineLength && char === ' ') {
                    result += '\\\\';
                    currentLineLength = 0;
                }
            }

            return result;
        }


    </script>
{% endblock %}
